# World of Warcraft 3.3.5a Server-Side Navigation and Pathfinding

This document provides a detailed technical overview of the server-side navigation and pathfinding systems used in World of Warcraft patch 3.3.5a (build 12340). The information is based on research from various sources, including community forums, source code repositories, and technical articles.

## 1. Overview

Server-side navigation in World of Warcraft relies on a combination of data structures to represent the game world and enable pathfinding for non-player characters (NPCs). The core components of this system are:

*   **MAPs:** Basic 2D heightmaps and terrain information.
*   **VMAPs (Visibility Maps):** 3D data used for line of sight (LoS) calculations and collision detection.
*   **MMAPs (Movement Maps):** 3D data used to generate navigation meshes for pathfinding.

These components work together to provide a comprehensive representation of the game world that the server can use to simulate realistic movement and interactions for NPCs.

## 2. Data Structures

While specific C-style struct definitions are not readily available in the documentation, the general structure of the data files is understood.

### 2.1. MAPs

Map files provide the fundamental 2D representation of the terrain. They contain:

*   **Heightmap:** The Z-axis (height) of the terrain at each X, Y coordinate.
*   **Area Data:** Information about different sub-zones within a map tile.
*   **Liquid Data:** Height and type of liquids (e.g., water, lava).
*   **Hole Map:** Data indicating areas where the terrain should not be rendered, allowing for the insertion of objects like caves or mines.

### 2.2. VMAPs (Visibility Maps)

VMAPs provide a 3D representation of the world used for LoS and collision. They are constructed using a Bounding Interval Hierarchy (BIH) and raytracing techniques.

The VMAP system consists of three main file types:

*   **.vmtree:** Contains the BIH for an entire world (WDT level).
*   **.vmtile:** Contains the BIH and model placement information for a single map tile (ADT level).
*   **.vmo:** Contains the BIH and geometry for a single World Model Object (WMO).

### 2.3. MMAPs (Movement Maps)

MMAPs are a 3D representation of the terrain used for pathfinding. They are used to generate a navigation mesh (navmesh), which is a simplified set of polygons that represents the walkable areas of the world.

The file structure of MMAPs is similar to the WDT/ADT organization of the main map files.

## 3. Pathfinding Algorithms

World of Warcraft's pathfinding is primarily based on the **Recast and Detour** libraries.

*   **Recast:** This library is used to generate the navmesh from the MMAP data. It takes the complex geometry of the game world and creates a simplified polygonal mesh that is easier to work with for pathfinding.
*   **Detour:** This library is used to find paths on the navmesh generated by Recast. It uses the A* (A-star) search algorithm to find the shortest path between two points on the navmesh, avoiding obstacles and impassable terrain.

## 4. Relationships to Other Systems

*   **WDT/ADT Files:** The core map files that provide the base geometry for VMAP and MMAP generation.
*   **WMO/M2 Files:** World Model Objects and other models that are included in the VMAP data for collision and LoS calculations.
*   **DBC Files:** Database files that contain various game data, some of which may be relevant to navigation and pathfinding.

## 5. Tools and Utilities

Several tools are used to extract and generate the necessary data for server-side navigation:

*   **mapextractor.exe:** Extracts map data from the game's MPQ files.
*   **vmap4extractor.exe:** Extracts VMAP data.
*   **vmap4assembler.exe:** Assembles the extracted VMAP data.
*   **mmaps_generator.exe:** Generates MMAPs from the extracted map and VMAP data.
*   **Recast Debug:** A tool for visualizing and debugging the generated navmeshes.

These tools are typically found in the source code of emulated server projects like TrinityCore and MaNGOS.

## 6. Code Examples

While no specific code examples were found, the general process of using Recast and Detour is as follows:

1.  Load the game's geometry data (from MMAPs).
2.  Use Recast to build a navmesh from the geometry.
3.  Use Detour to create a navmesh query object.
4.  Use the navmesh query object to find a path between a start and end point.

```cpp
// Pseudocode for pathfinding with Recast/Detour

// 1. Load navmesh
dtNavMesh* navMesh = loadNavMesh("path/to/navmesh.mmap");

// 2. Create navmesh query
dtNavMeshQuery* navQuery = new dtNavMeshQuery();
navQuery->init(navMesh, 2048);

// 3. Define start and end points
float startPos[3] = {x1, y1, z1};
float endPos[3] = {x2, y2, z2};

// 4. Find path
dtQueryFilter filter;
dtPolyRef startRef, endRef;
float nearestPt[3];
navQuery->findNearestPoly(startPos, extents, &filter, &startRef, nearestPt);
navQuery->findNearestPoly(endPos, extents, &filter, &endRef, nearestPt);

dtPolyRef path[MAX_PATH_POLYS];
int pathCount;
navQuery->findPath(startRef, endRef, startPos, endPos, &filter, path, &pathCount, MAX_PATH_POLYS);
```

## 7. Sources

*   [https://www.getmangos.eu/forums/topic/10829-what-are-maps-mmaps-and-vmaps-exactly/](https://www.getmangos.eu/forums/topic/10829-what-are-maps-mmaps-and-vmaps-exactly/)
*   [https://github.com/stoneharry/mmaps-for-custom-maps](https://github.com/stoneharry/mmaps-for-custom-maps)
*   [https://drewkestell.us/Article/6/Chapter/20](https://drewkestell.us/Article/6/Chapter/20)
